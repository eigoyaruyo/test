# 概要
日付と緯度経度を持つデータを、年代毎に配置された地図にマッピングします。  
地図、データ、画面に表示するデータの項目、各種設定を変更できます。  


#ファイルの構成
```	
index.html				// Viewer表示用HTML  
/css  
	base.css			// Viewerのスタイル設定  
/data  
	data_japan.json		// イベントサンプルデータ（日本対象）  
	data_world.json		// イベントサンプルデータ（世界対象）  
	japan.php			// イベントサンプルデータを返すダミーサーバサイド（日本対象）  
	world.php			// イベントサンプルデータを返すダミーサーバサイド（世界対象）  
	japan.geojson		// 日本地図データ  
	world.geojson		// 世界地図データ  
	settings.json		// 設定ファイル  
	label_template.txt	// 画面に表示する情報ラベルのテンプレート  
	noimage.png			// 画像サンプルデータ  
	sample.png			// 画像サンプルデータ  
/fonts					// フォント用データ  
/lib					// 使用ライブラリ  
/script  
	viewer.js			// Viewer用メインスクリプト  
```	

# 操作説明
## 全体図（3D）表示時の画面項目説明
1. 年代の範囲スライダー  
開始年以上、終了年未満のデータを取得し、データオブジェクト、データライン、データラベルを表示します。  

2. 年代の選択スライダー  
スライドさせることで特定の年代を選択します。  
選択された年代のデータオブジェクト、データラインが表示されます。  
選択された年代のデータラベルが表示されます。  
選択された年代以外のマップは透過され、データオブジェクト、データラインは非表示になります。  

3. データオブジェクト、データライン  
データオブジェクト（赤い立方体）の配置位置はデータ開始年。オブジェクトの長さは期間を表します。  
データライン（青い線）は地図座標からデータオブジェクトまでを結ぶラインになります。  

4. データラベル  
データの項目を表示しています。  

5. データラベルと地図座標間ライン  
データラベルと地図座標間を結んでいます。  

6. 各年代地図
年代の範囲スライダーで選択した範囲を複数の年代に分けて、各々の年代に地図を表示しています。  

7. 各年代ラベル  
各地図の年代開始年を表示します。  

8. 選択を解除するボタン  
年代の選択を解除します。  

9. 設定ボタン  
設定モーダルを開きます。  
使用するデータの選択ができます。  
ビューコントローラーの移動、回転、拡大・縮小のスピードを選択できます。  

10. 年代選択矢印  
年代を一つ前、一つ後に移動します。  

11. 年代表示補助ラベル  
地図の年代ラベルが、視点の移動や回転、拡大・縮小した際に見えなくなるのを補助します。  

## 全体図（3D）表示時のマウス操作  
1. 視点の回転 ・・・ ドラッグアンドドロップ  
2. 視点の拡大・縮小 ・・・ マウスホイール（macは2本指上下スライド）  
3. 年代の詳細図（2D）表示 ・・・ 地図をダブルクリック  
4. 年代選択の解除 ・・・ 何もない空間をダブルクリック（選択を解除するボタンと同じ）  

## 詳細図（2D）表示時の画面項目説明  
1. 座標点オブジェクト  
データの座標にマッピングされたオブジェクトです。データラベルとこのオブジェクト間にラインが引かれます。  

2. 詳細を閉じるボタン  
詳細図（2D）表示から全体図（3D）表示に戻ります。  

## 詳細図（2D）表示時のマウス操作  
1. 視点の移動 ・・・ ドラッグアンドドロップ  
2. 視点の拡大・縮小 ・・・ マウスホイール（macは2本指上下スライド）  

## 詳細図（2D）表示時のキーボード操作  
全体図（3D）表示に戻る ・・・ エスケープキー押下  


# 地図の変更  
地図データは、shape形式の地図ファイルをGeoJson形式(featuresCollectionタイプ)に変換したものを使用します。  
使用する地図データのパスは、設定ファイルの地図データファイルパス（settings.geo.file）に記載して下さい。  
画面に表示する地図のサイズについては、設定ファイルの地図表示サイズ（settings.geo.scale）に記載して下さい。  
画面に表示する地図の中央位置については、設定ファイルの地図中央（settings.geo.center）に記載してください。  
中央位置の記載がない場合には地図データから中央座標を取得して使用します。  
地図データのサイズが大きいと全体の挙動が遅くなります。地図データサンプルのサイズを参考にしてください。  

** GeoJson取得参考 **  
以下のサイトから地図をダウンロードします。  
[Natural Earth](http://www.naturalearthdata.com/downloads/110m-cultural-vectors/)  
[国土交通省国土政策局国土情報課](http://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03.html)  

アプリケーション、またはWebサービスから地図をGeoJson形式に変更します。  
[mapshaper](http://www.mapshaper.org/)  
[QGIS](http://qgis.org/ja/site/)  

地図データのサイズを下げたい場合  
[mapshaper](http://www.mapshaper.org/)  

** 設定ファイル該当部分 **  
```	
"geo":{
	"name": "world",
	"file": "data/world.geojson",
	"scale": 100,
	"center": [0,0],
	"range": [[-180, -90], [180, 90]]
}
```	

** 範囲指定、中央指定がない設定パターン **
```	
"geo":{
	"name": "tokyo",
	"file": "data/japan.geojson",
	"scale": 1000
}
```	


# データの変更
取り扱うデータの項目として、ID（id）、開始年（start）、 終了年（end）、経度（lng）、緯度（lat）は必須です。  
データの取得先は、デフォルトでは設定ファイルのデータ配列最初の値を使用します。  
（settings.data[0].urlに記載されているパス）  

データの項目名については、データラベル作成時にテンプレートファイルに記載された’[データ項目名]’タグに使用され、データの値に置換されます。詳しくは「ラベルの変更」を参照してください。  

** データ構造例 **  
```	
[
	{
		"id": 0,
		"start": "1896/3/1",
		"end": "1896/3/1",
		"title": "アドワの戦い",
		"description": "アドワの戦い（アドワのたたかい）は、1896年3月1日にエチオピア軍とイタリア軍が・・・",
		"link": "http://ja.wikipedia.org/wiki/・・・",
		"img": "http://upload.wikimedia.org/wikipedia/commons/6/66/Adua_Menelik.jpg",
		"lat": 6.36667,
		"lng": -1.73333
	},
	 ・・・
]
```	

※日付については年代部分を取得しております。スラッシュ区切りがあった場合にも対応しています。  
 （例： 「9999」、「9999/12」、「9999/12/31」）  
  紀元前の扱いについては西暦に負記号を付けて用いています。  
 （例：-2、-1、0、１、2）

※ダミーサーバサイドはサンプルデータを読み込み、クライアントからの要求に該当する値を返却しています。  


# ラベルの変更
データラベルテンプレート（data/label_template.txt）に記載されているHTMLを利用してレイアウトを行います。  
CSSによる装飾は、’css/base.css’に記載しています。  
データラベルテンプレートに記載されている’[   ]’タグ内にデータの項目名を記載することで対応する値への置換が行われます。  
座標オブジェクトとデータラベル間のラインの装飾は、’css/base.css’に記載しています。  

** データの項目置換例 **  
取得したデータ  
```	
{
	"id": 0,
	"start": "1896/3/1",
	"end": "1896/3/1",
	"title": "アドワの戦い",
	"description": "アドワの戦い（アドワのたたかい）は、1896年3月1日にエチオピア軍とイタリア軍が・・・",
	"link": "http://ja.wikipedia.org/wiki/・・・",
	"img": "http://upload.wikimedia.org/wikipedia/commons/6/66/Adua_Menelik.jpg",
	"lat": 6.36667,
	"lng": -1.73333
},
```	

ラベルテンプレート  
```	
<div id="label[id]" class="datalabel-wrap">
	<div class="datalabel">
		<a class="datalabel-link" href="[link]" target="_blank"></a>
		<div class="datalabel-image" style="background:url('[img]') no-repeat 50% 50%; …"></div>
		<div class="datalabel-title">[title]</div>
		<div class="datalabel-date">[start] : [end]</div>
	</div>
</div>
```	

※ラベルテンプレートに「id=”label[id]”」は必須です。座標点オブジェクトとラベル間にラインを引くのに使用されます。  
※データの項目名「link」の値がラベルテンプレートの[link]部分と置換されます。  
※データの項目名「img」の値がラベルテンプレートの[img]部分と置換されます。  


# 設定ファイルの説明  
```	
{
	"data": [									// 使用するデータの配列
		{
			"title": "戦争・戦闘（世界対象）",	// 設定モーダルに表示される名称
			"url": "data/world.php"				// データを返すサーバサイドのパス
		},
		{
			"title": "データサンプル（日本対象）",
			"url": "data/japan.php"
		}
	],
	
	"range": {				// 年代の範囲選択スライダーの初期値
		"min": -2000,		// 最小値
		"max": 2000,		// 最大値
		"minValue": -2000,	// 選択最小値
		"maxValue": 2000	// 選択最大値
	},
	
	"control": {					// ビューの操作設定
		"win": {					// Windows系の操作設定
			"zoomSpeed": 1.0,		// 拡大・縮小のスピード
			"rotateSpeed": 1.0,		// 回転のスピード
			"panSpeed": 1.0			// 2D画面時の地図内移動のスピード
		},
		"mac": {					// Mac系の操作設定
			"zoomSpeed": 0.2,
			"rotateSpeed": 1.0,
			"panSpeed": 1.0
		},
		
		"minDistance": 10,			// 最小移動域
		"maxDistance": 4000			// 最大移動域
	},
	
	"geo":									// 地図データの設定
	{
		"name": "world",					// 使用する地図の名称
		"file": "data/world.geojson",		// 使用する地図データのパス
		"scale": 100,						// 地図のサイズ
		"center": [0,0],					// 地図の中心座標
		"range": [[-180, -90], [180, 90]]	// 座標範囲
	},
	"map": {					// 表示地図の設定
		"count": 10,			// 表示地図数（年代数）
		"distance": 300,		// 地図間距離
		"labelFontSize" : 50,	// 年代ラベルのフォントサイズ
		"margin": 20			// 地図背景の余白
	},
	"label": {									// ラベルの設定
		"count": 8,								// ラベル表示数
		"template": "data/label_template.txt"	// ラベルテンプレートへのパス
	},
	"color": {							// 色の設定
		"renderer": {
			"background": "#000000"		// 空間の色
		},
		"world": {
			"map": "#aaaaaa",			// 地図の色
			"background": "#cccccc",	// 地図の背景色
			"group": "#ffffff"			// 年代ラベルの色
		},
		"data": {
			"point": "#ff3333",			// 座標オブジェクトの色
			"box": "#ff3333",			// データオブジェクトの色
			"line": "#3333ff"			// ラインオブジェクトの色
		}
	}
}
```	

